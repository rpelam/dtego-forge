<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Bibliothèque - Dtego Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        .library-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .library-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="text-white p-8">
    <div class="max-w-7xl mx-auto glass-container p-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-bold mb-1" style="color: #d97706;">Bibliothèque</h1>
                    <p class="text-white/40 text-sm">Gérez vos indicateurs, stratégies et composants</p>
                </div>
                <div class="flex gap-3">
                    <a href="index.html#atelier" class="px-4 py-2 rounded-lg text-white text-sm font-medium transition hover:-translate-y-0.5 hover:shadow-lg" style="background: linear-gradient(135deg, #0891b2, #06b6d4); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                        Atelier
                    </a>
                    <button id="btnRefresh" onclick="refreshLibrary()" class="px-4 py-2 rounded-lg text-white text-sm font-medium transition hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed" style="background: #8b5cf6;">
                        <span id="refreshText">Actualiser</span>
                        <span id="refreshSpinner" class="hidden inline-flex items-center">
                            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex items-center gap-3 mb-6">
            <button id="btnAll" onclick="filterType('all')" class="px-4 py-2 rounded-xl text-sm font-medium transition-all" style="background: #a78bfa30; color: #a78bfa; border: 1px solid #a78bfa50;">
                Tout <span id="countAll" class="ml-2 text-xs px-2 py-0.5 rounded-full bg-white/20">0</span>
            </button>
            <button id="btnProjet" onclick="filterType('projet')" class="px-4 py-2 rounded-xl text-sm font-medium transition-all" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid transparent;">
                Projets <span id="countProjet" class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.1);">0</span>
            </button>
            <button id="btnStrategie" onclick="filterType('strategie')" class="px-4 py-2 rounded-xl text-sm font-medium transition-all" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid transparent;">
                Stratégies <span id="countStrategie" class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.1);">0</span>
            </button>
            <button id="btnIndicateur" onclick="filterType('indicateur')" class="px-4 py-2 rounded-xl text-sm font-medium transition-all" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid transparent;">
                Indicateurs <span id="countIndicateur" class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.1);">0</span>
            </button>
            <button id="btnFiltre" onclick="filterType('filtre')" class="px-4 py-2 rounded-xl text-sm font-medium transition-all" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid transparent;">
                Filtres <span id="countFiltre" class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.1);">0</span>
            </button>
            <button id="btnCondition" onclick="filterType('condition')" class="px-4 py-2 rounded-xl text-sm font-medium transition-all" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid transparent;">
                Conditions <span id="countCondition" class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.1);">0</span>
            </button>
            <button id="btnGranule" onclick="filterType('granule')" class="px-4 py-2 rounded-xl text-sm font-medium transition-all" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid transparent;">
                Granules <span id="countGranule" class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background: rgba(255,255,255,0.1);">0</span>
            </button>
        </div>

        <!-- Grid -->
        <div id="libraryGrid" class="grid grid-cols-4 gap-4">
            <!-- Rempli dynamiquement -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <svg class="w-12 h-12 text-white/20 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            <p class="text-white/40 text-sm">Aucun élément trouvé</p>
        </div>
    </div>

    <!-- Modal Détails -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="closeDetailsModal()">
        <div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);" class="rounded-2xl p-5 max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 id="modalTitle" class="text-lg font-semibold text-white mb-2"></h3>
                    <span id="modalBadge" class="inline-block px-2 py-1 rounded text-xs font-medium"></span>
                </div>
                <button onclick="closeDetailsModal()" class="w-8 h-8 rounded-lg flex items-center justify-center transition hover:bg-white/10" style="color: rgba(255, 255, 255, 0.4);">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div id="modalContent" class="bg-white/5 rounded-xl p-4 mb-5 space-y-2" style="font-size: 13px; color: rgba(255, 255, 255, 0.7);">
                <!-- Rempli dynamiquement -->
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="loadInAtelier()" class="px-3 py-3 rounded-xl font-medium text-sm transition hover:opacity-90" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
                    Ouvrir
                </button>
                <button onclick="editItem()" class="px-3 py-3 rounded-xl font-medium text-sm transition hover:opacity-90" style="background: rgba(180, 83, 9, 0.85); color: white;">
                    Éditer
                </button>
                <button onclick="confirmDelete()" class="px-3 py-3 rounded-xl font-medium text-sm transition hover:opacity-90" style="background: rgba(127, 29, 29, 0.85); color: #f87171;">
                    Supprimer
                </button>
            </div>
            
            <button onclick="closeDetailsModal()" class="w-full text-center text-white/40 text-sm py-2 hover:text-white/60 transition">
                Annuler
            </button>
        </div>
    </div>


    <!-- Modal Confirmation Custom -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50" onclick="closeConfirmModal()">
        <div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);" class="rounded-2xl p-5 max-w-sm w-full shadow-2xl mx-4" onclick="event.stopPropagation()">
            <h3 id="confirmTitle" class="text-lg font-semibold text-white mb-3"></h3>
            <p id="confirmMessage" class="text-white/60 text-sm mb-6"></p>
            
            <div class="flex gap-3">
                <button id="confirmCancel" onclick="closeConfirmModal()" class="flex-1 px-4 py-3 rounded-xl font-medium text-sm transition hover:bg-white/10" style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.1);">
                    Annuler
                </button>
                <button id="confirmOk" class="flex-1 px-4 py-3 rounded-xl font-medium text-sm transition hover:opacity-90" style="color: white;">
                    Confirmer
                </button>
            </div>
        </div>
    </div>

    <script>
        let allItems = [];
        let currentFilter = 'all';
        let currentItemId = null;

        // Mapping type API (anglais) -> label français
        const typeToLabel = {
            'strategy': 'strategie',
            'indicator': 'indicateur',
            'filter': 'filtre',
            'condition': 'condition',
            'project': 'projet'
        };

        const labelToType = {
            'strategie': 'strategy',
            'indicateur': 'indicator',
            'filtre': 'filter',
            'condition': 'condition',
            'projet': 'project'
        };

        // Couleurs par type
        const typeColors = {
            'indicator': { bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.3)', icon: '#3b82f6', tab: '#3b82f6' },
            'strategy': { bg: 'rgba(16, 185, 129, 0.1)', border: 'rgba(16, 185, 129, 0.3)', icon: '#10b981', tab: '#10b981' },
            'filter': { bg: 'rgba(245, 158, 11, 0.1)', border: 'rgba(245, 158, 11, 0.3)', icon: '#f59e0b', tab: '#f59e0b' },
            'condition': { bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.3)', icon: '#3b82f6', tab: '#3b82f6' },
            'project': { bg: 'rgba(20, 184, 166, 0.1)', border: 'rgba(20, 184, 166, 0.3)', icon: '#14b8a6', tab: '#14b8a6' }
        };

        async function loadLibraryItems() {
            console.log("[DEBUG] Chargement items...");
            try {
                const response = await fetch('https://api.dtego.net/api/library');
                const result = await response.json();
                
                if (result.success && result.items) {
                    console.log("[DEBUG] API retourne:", result.items.length, "items");
                    allItems = result.items;
                    console.log("[DEBUG] allItems défini:", allItems.length);
                } else {
                    console.error('Erreur chargement:', result.error);
                    allItems = [];
                }
            } catch (error) {
                console.error('Erreur:', error);
                allItems = [];
            }
            
            updateCounts();
            displayItems();
            console.log("[DEBUG] displayItems appelé, currentFilter:", currentFilter);
        }

        async function refreshLibrary() {
            const btn = document.getElementById('btnRefresh');
            const textSpan = document.getElementById('refreshText');
            const spinnerSpan = document.getElementById('refreshSpinner');
            
            // Disable button
            btn.disabled = true;
            textSpan.classList.add('hidden');
            spinnerSpan.classList.remove('hidden');
            
            // Reload
            await loadLibraryItems();
            
            // Re-enable after 500ms
            setTimeout(() => {
                btn.disabled = false;
                textSpan.classList.remove('hidden');
                spinnerSpan.classList.add('hidden');
            }, 500);
        }

        function updateCounts() {
            const counts = {
                all: allItems.length,
                strategie: allItems.filter(i => i.type === 'strategy').length,
                indicateur: allItems.filter(i => i.type === 'indicator').length,
                filtre: allItems.filter(i => i.type === 'filter').length,
                condition: allItems.filter(i => i.type === 'condition').length,
                projet: allItems.filter(i => i.type === 'project').length
            };

            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countStrategie').textContent = counts.strategie;
            document.getElementById('countIndicateur').textContent = counts.indicateur;
            document.getElementById('countFiltre').textContent = counts.filtre;
            document.getElementById('countCondition').textContent = counts.condition;
            document.getElementById('countProjet').textContent = counts.projet;
        }

        function filterType(type) {
            currentFilter = type;
            
            // Update tab styles
            const tabs = ['All', 'Projet', 'Strategie', 'Indicateur', 'Filtre', 'Condition'];
            tabs.forEach(t => {
                const btn = document.getElementById('btn' + t);
                const isActive = (type === 'all' && t === 'All') || (type === t.toLowerCase());
                
                if (isActive) {
                    if (type === 'all') {
                        // Onglet "Tout" actif = Violet
                        btn.style.background = '#a78bfa30';
                        btn.style.color = '#a78bfa';
                        btn.style.border = '1px solid #a78bfa50';
                    } else {
                        // Autres onglets = leur couleur spécifique
                        const color = typeColors[labelToType[type]]?.tab || '#3b82f6';
                        btn.style.background = `${color}20`;
                        btn.style.color = color;
                        btn.style.border = `1px solid ${color}50`;
                    }
                } else {
                    btn.style.background = 'rgba(255,255,255,0.05)';
                    btn.style.color = 'rgba(255,255,255,0.5)';
                    btn.style.border = '1px solid transparent';
                }
            });
            
            displayItems();
        }

        function displayItems() {
            let filtered = allItems;
            
            if (currentFilter !== 'all') {
                const apiType = labelToType[currentFilter] || currentFilter;
                filtered = allItems.filter(i => i.type === apiType);
            }

            const grid = document.getElementById('libraryGrid');
            const empty = document.getElementById('emptyState');

            if (filtered.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            grid.innerHTML = filtered.map(item => renderCard(item)).join('');
        }

        function renderCard(item) {
            const color = typeColors[item.type] || typeColors['indicator'];
            const typeLabel = typeToLabel[item.type] || item.type;
            
            // Score badge (% en haut à droite)
            const score = item.confidence_score || item.score || 0;
            const hasScore = score > 0;
            const scorePercent = hasScore ? Math.round(score) : '—';
            const scoreColor = hasScore ? (score >= 80 ? '#22c55e' : score >= 60 ? '#f59e0b' : '#ef4444') : 'rgba(255,255,255,0.25)';
            const scoreBg = hasScore ? `${scoreColor}20` : 'rgba(255,255,255,0.05)';

            // Icône selon type
            const icons = {
                'indicator': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>',
                'strategy': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>',
                'filter': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>',
                'condition': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>',
                'project': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>'
            };

            return `
                <div class="library-card p-4 rounded-xl border" style="background: ${color.bg}; border-color: ${color.border};" onclick="showDetails('${item.id}')">
                    <div class="flex items-start justify-between mb-3">
                        <svg class="w-5 h-5 flex-shrink-0" style="color: ${color.icon};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${icons[item.type] || icons['indicator']}
                        </svg>
                        <span class="px-2 py-1 rounded-lg text-xs font-semibold" style="background: ${scoreBg}; color: ${scoreColor}; min-width: 32px; text-align: center;">
                            ${hasScore ? scorePercent + '%' : scorePercent}
                        </span>
                    </div>
                    <h3 class="text-white font-semibold text-sm mb-1 line-clamp-2">${item.name || 'Sans nom'}</h3>
                    <p class="text-white/40 text-xs mb-3">${item.version || 'v5'}</p>
                    
                    <div class="flex flex-wrap gap-1.5">
                        <span class="px-2 py-0.5 rounded text-xs font-medium" style="background: ${color.bg}; color: ${color.icon}; border: 1px solid ${color.border};">
                            ${typeLabel.charAt(0).toUpperCase() + typeLabel.slice(1)}
                        </span>
                    </div>
                </div>
            `;
        }

        function showDetails(itemId) {
            currentItemId = itemId;
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;

            const color = typeColors[item.type] || typeColors['indicator'];
            const typeLabel = typeToLabel[item.type] || item.type;

            document.getElementById('modalTitle').textContent = item.name || 'Sans nom';
            
            const badge = document.getElementById('modalBadge');
            badge.textContent = typeLabel.charAt(0).toUpperCase() + typeLabel.slice(1);
            badge.style.background = color.bg;
            badge.style.color = color.icon;
            badge.style.border = `1px solid ${color.border}`;

            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-2 text-sm">
                    ${item.description ? `<p class="text-white/70">${item.description}</p>` : ''}
                    <div class="flex justify-between py-1 border-t border-white/10">
                        <span class="text-white/50">Version:</span>
                        <span class="text-white">${item.version || 'v5'}</span>
                    </div>
                    ${item.author ? `
                    <div class="flex justify-between py-1">
                        <span class="text-white/50">Auteur:</span>
                        <span class="text-white">${item.author}</span>
                    </div>
                    ` : ''}
                    ${item.created_at ? `
                    <div class="flex justify-between py-1">
                        <span class="text-white/50">Créé le:</span>
                        <span class="text-white">${new Date(item.created_at).toLocaleDateString('fr-FR')}</span>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            currentItemId = null;
        }

        function loadInAtelier() {
            if (!currentItemId) return;
            window.location.href = `index.html#atelier?load=${currentItemId}`;
        }

        function editItem() {
            if (!currentItemId) return;
            showConfirm(
                'Fonction en développement',
                'La fonction d\'édition sera disponible prochainement.',
                'OK',
                () => {},
                '#6366f1',
                true // single button
            );
        }

        function confirmDelete() {
            if (!currentItemId) return;
            const item = allItems.find(i => i.id === currentItemId);
            showConfirm(
                'Supprimer cet élément ?',
                `Êtes-vous sûr de vouloir supprimer "${item?.name || 'cet élément'}" ? Cette action est irréversible.`,
                'Supprimer',
                async () => {
                    // TODO: Appel API DELETE
                    showConfirm('Suppression', 'Fonction de suppression à implémenter.', 'OK', () => {}, '#6366f1', true);
                },
                '#ef4444' // rouge
            );
        }

        // Système modal confirmation custom
        let confirmCallback = null;

        function showConfirm(title, message, okText = 'Confirmer', onConfirm = () => {}, okColor = '#6366f1', singleButton = false) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmOk').textContent = okText;
            document.getElementById('confirmOk').style.background = okColor;
            
            // Si single button, cacher annuler et agrandir OK
            const cancelBtn = document.getElementById('confirmCancel');
            const okBtn = document.getElementById('confirmOk');
            if (singleButton) {
                cancelBtn.style.display = 'none';
                okBtn.classList.remove('flex-1');
                okBtn.style.width = '100%';
            } else {
                cancelBtn.style.display = 'block';
                okBtn.classList.add('flex-1');
                okBtn.style.width = 'auto';
            }
            
            confirmCallback = onConfirm;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        // Action OK
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('confirmOk').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            });
        });

        // Chargement initial
        window.addEventListener('DOMContentLoaded', () => {
            loadLibraryItems();
        });
    </script>
</body>
</html>
