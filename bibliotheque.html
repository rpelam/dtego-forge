<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Bibliothèque - Dtego Trading</title>
    <!-- Cache-bust: 1770255920 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f0f1a 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .nav-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        /* Couleurs TOUJOURS actives (comme menu principal) */
        #btnAll { 
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        #btnStrategie { 
            background: linear-gradient(135deg, #047857, #059669);
        }
        #btnIndicateur { 
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }
        #btnFiltre { 
            background: linear-gradient(135deg, #b45309, #d97706);
        }
        #btnCondition { 
            background: linear-gradient(135deg, #2563eb, #3b82f6);
        }
        /* Actif = plus lumineux */
        .nav-btn.active {
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .item-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .item-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
        }
        .item-card.strategie { border-left: 3px solid #4ade80; }
        .item-card.indicateur { border-left: 3px solid #a78bfa; }
        .item-card.filtre { border-left: 3px solid #fbbf24; }
        .item-card.condition { border-left: 3px solid #38bdf8; }
        
        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-strategie { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .badge-indicateur { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }
        .badge-filtre { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .badge-condition { background: rgba(56, 189, 248, 0.2); color: #38bdf8; }
    </style>
</head>
<body>
    <div class="p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white">Bibliothèque</h1>
                <p class="text-white/50 text-sm">Vos stratégies, indicateurs, filtres et conditions</p>
            </div>
            <div class="flex gap-3">
                                <a href="index.html#atelier" class="px-4 py-2 rounded-lg text-white text-sm font-medium transition hover:-translate-y-0.5 hover:shadow-lg" style="background: linear-gradient(135deg, #b45309, #d97706); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                    Atelier
                </a>
                <button onclick="loadLibraryItems()" class="px-4 py-2 rounded-lg text-sm font-medium transition hover:bg-white/10 border" style="background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.8);">
                    ↻ Rafraîchir
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex gap-2 mb-6">
            <button onclick="filterType('all')" id="btnAll" class="nav-btn active">Tout (0)</button>
            <button onclick="filterType('strategie')" id="btnStrategie" class="nav-btn">Stratégies (0)</button>
            <button onclick="filterType('indicateur')" id="btnIndicateur" class="nav-btn">Indicateurs (0)</button>
            <button onclick="filterType('filtre')" id="btnFiltre" class="nav-btn">Filtres (0)</button>
            <button onclick="filterType('condition')" id="btnCondition" class="nav-btn">Conditions (0)</button>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden glass rounded-xl p-12 text-center">
            <div class="text-white/30 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
            </div>
            <p class="text-white/50 text-lg mb-2">Bibliothèque vide</p>
            <p class="text-white/30 text-sm">Créez vos premières stratégies dans l'Atelier</p>
        </div>

        <!-- Items Grid -->
        <div id="itemsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Rempli dynamiquement -->
        </div>
    </div>

    <!-- Modal Détails -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="closeDetailsModal()">
        <div class="bg-[#1a1a2e]/95 backdrop-blur-xl rounded-2xl p-6 max-w-md w-full border border-white/10 shadow-2xl" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 id="modalTitle" class="text-lg font-semibold text-white mb-2"></h3>
                    <span id="modalBadge" class="badge"></span>
                </div>
                <button onclick="closeDetailsModal()" class="w-8 h-8 rounded-lg flex items-center justify-center transition hover:bg-white/10" style="color: rgba(255, 255, 255, 0.4);">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Infos Section (style gris foncé) -->
            <div id="modalContent" class="bg-white/5 rounded-xl p-4 mb-5 space-y-2" style="font-size: 13px; color: rgba(255, 255, 255, 0.7);">
                <!-- Rempli dynamiquement -->
            </div>
            
            <!-- Actions (3 boutons larges) -->
            <div class="space-y-3 mb-4">
                <button onclick="loadInAtelier()" class="w-full px-4 py-3 rounded-xl font-medium transition hover:opacity-90" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white;">
                    Ouvrir dans Atelier
                </button>
                <button onclick="editItem()" class="w-full px-4 py-3 rounded-xl font-medium transition" style="background: rgba(180, 83, 9, 0.8); color: white;">
                    Éditer
                </button>
                <button onclick="confirmDelete()" class="w-full px-4 py-3 rounded-xl font-medium transition" style="background: rgba(127, 29, 29, 0.8); color: #f87171;">
                    Supprimer
                </button>
            </div>
            
            <!-- Annuler -->
            <button onclick="closeDetailsModal()" class="w-full text-center text-white/40 text-sm py-2 hover:text-white/60 transition">
                Annuler
            </button>
        </div>
    </div>

    </div>


    <script>
        
        let allItems = [];
        let currentFilter = 'all';
        let currentItem = null;

        async function loadLibraryItems() {
            console.log("[DEBUG] Chargement items...");
            try {
                const response = await fetch('https://api.dtego.net/api/library/items');
                const result = await response.json();
                
                if (result.success && result.items) {
                    console.log("[DEBUG] API retourne:", result.items.length, "items");
                    allItems = result.items;
                    console.log("[DEBUG] allItems défini:", allItems.length);
                } else {
                    console.error('Erreur chargement:', result.error);
                    allItems = [];
                }
            } catch (error) {
                console.error('Erreur:', error);
                allItems = [];
            }
            
            updateCounts();
            displayItems();
            console.log("[DEBUG] displayItems appelé, currentFilter:", currentFilter);
        }

        function updateCounts() {
            const counts = {
                all: allItems.length,
                strategie: allItems.filter(i => i.type === 'strategy').length,
                indicateur: allItems.filter(i => i.type === 'indicator').length,
                filtre: allItems.filter(i => i.type === 'filter').length,
                condition: allItems.filter(i => i.type === 'condition').length
            };
            
            document.getElementById('btnAll').textContent = `Tout (${counts.all})`;
            document.getElementById('btnStrategie').textContent = `Stratégies (${counts.strategie})`;
            document.getElementById('btnIndicateur').textContent = `Indicateurs (${counts.indicateur})`;
            document.getElementById('btnFiltre').textContent = `Filtres (${counts.filtre})`;
            document.getElementById('btnCondition').textContent = `Conditions (${counts.condition})`;
        }

        function filterType(type) {
            currentFilter = type;
            
            // Update active button
            ['btnAll', 'btnStrategie', 'btnIndicateur', 'btnFiltre', 'btnCondition'].forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('active');
            });
            document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
            
            displayItems();
        }

        function displayItems() {
            let filtered = allItems;
            
            if (currentFilter !== 'all') {
                // Mapping français -> anglais
                const typeMap = {'strategie': 'strategy', 'indicateur': 'indicator', 'filtre': 'filter', 'condition': 'condition'};
                const apiType = typeMap[currentFilter] || currentFilter;
                filtered = allItems.filter(i => i.type === apiType);
            }
            
            const grid = document.getElementById('itemsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filtered.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            grid.innerHTML = filtered.map(item => {
                // Mapping type API -> label français
                const typeToLabel = {'strategy': 'strategie', 'indicator': 'indicateur', 'filter': 'filtre', 'condition': 'condition'};
                const itemType = typeToLabel[item.type] || 'strategie';
                const badgeClass = 'badge-' + itemType;
                const badgeText = itemType === 'strategie' ? 'STRATÉGIE' : 
                                 itemType === 'indicateur' ? 'INDICATEUR' : 
                                 itemType === 'filtre' ? 'FILTRE' : 'CONDITION';
                
                // Détection Session 41
                const hasIndicators = item.indicators_detected && item.indicators_detected.length > 0;
                const confidence = item.confidence_score ? (item.confidence_score * 100).toFixed(0) + '%' : null;
                
                return `
                    <div class="item-card ${itemType}" onclick="showDetails('${item.id}')">
                        <div class="flex justify-between items-start mb-3">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            ${confidence ? `<span class="text-xs text-green-400 font-semibold">${confidence}</span>` : ''}
                        </div>
                        <h3 class="text-white font-bold text-lg mb-2">${item.name}</h3>
                        ${hasIndicators ? `
                            <div class="flex gap-2 flex-wrap mb-2">
                                ${item.indicators_detected.slice(0, 3).map(ind => `
                                    <span class="text-xs px-2 py-1 rounded" style="background: rgba(167, 139, 250, 0.2); color: #a78bfa;">
                                        ${ind.indicator}
                                    </span>
                                `).join('')}
                                ${item.indicators_detected.length > 3 ? `<span class="text-xs text-white/50">+${item.indicators_detected.length - 3}</span>` : ''}
                            </div>
                        ` : ''}
                        <p class="text-white/50 text-sm">${new Date(item.created_at).toLocaleDateString('fr-FR')}</p>
                    </div>
                `;
            }).join('');
        }

        function showDetails(itemId) {
            currentItem = allItems.find(i => i.id === itemId);
            if (!currentItem) return;
            
            const itemType = currentItem.type === 'strategy' ? 'strategie' : currentItem.category || 'strategie';
            const badgeClass = 'badge-' + itemType;
            const badgeText = itemType === 'strategie' ? 'STRATÉGIE' : 
                             itemType === 'indicateur' ? 'INDICATEUR' : 
                             itemType === 'filtre' ? 'FILTRE' : 'CONDITION';
            
            document.getElementById('modalTitle').textContent = currentItem.name;
            document.getElementById('modalBadge').className = 'badge ' + badgeClass;
            document.getElementById('modalBadge').textContent = badgeText;
            
            let content = '';
            
            // Session 41: Afficher indicateurs détectés
            if (currentItem.indicators_detected && currentItem.indicators_detected.length > 0) {
                content += `
                    <div class="glass rounded-lg p-4">
                        <h4 class="text-white font-semibold mb-3">Indicateurs Détectés (${currentItem.indicators_detected.length})</h4>
                        <div class="space-y-2">
                            ${currentItem.indicators_detected.map(ind => `
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-white/80">${ind.indicator}</span>
                                    <span class="text-green-400 font-semibold">${(ind.confidence * 100).toFixed(0)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Frozen data preview
            if (currentItem.frozen_data) {
                content += `
                    <div class="glass rounded-lg p-4">
                        <h4 class="text-white font-semibold mb-2">Données Figées</h4>
                        <p class="text-white/50 text-sm">Cette stratégie est optimisée (chargement instantané)</p>
                    </div>
                `;
            }
            
            // Dates
            content += `
                <div class="glass rounded-lg p-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-white/50">Créé le</span>
                        <span class="text-white/80">${new Date(currentItem.created_at).toLocaleString('fr-FR')}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            currentItem = null;
        }

        function loadInAtelier() {
            if (!currentItem) return;
            localStorage.setItem('dtego_load_item', JSON.stringify(currentItem));
            window.location.href = 'atelier.html';
        }

        function editItem() {
            alert('Édition (à implémenter)');
        }

        async function confirmDelete() {
            if (!currentItem) return;
            if (!confirm(`Supprimer "${currentItem.name}" ?`)) return;
            

            
            if (error) {
                alert('Erreur: ' + error.message);
                return;
            }
            
            closeDetailsModal();
            loadLibraryItems();
        }

        // Load on start
        loadLibraryItems();
    </script>
</body>
</html>
